DVAR $hFile
DVAR $cCheck
DVAR $press
DVAR $length
DVAR $lame
DVAR $comport


DVAR $found, $floor $delta $deltafast $Ax $Ay $Bx $By $Cx $Cy $Dx $Dy $Px $Py $posA $posB $posC $posD $posZ $fastfeed $midfeed $slowfeed $Astart $Bstart $Cstart $Dstart $Pstart $comma1 $comma2 $comma1plus $comma2plus
DVAR $Ax_dif $Ay_dif $Bx_dif $By_dif $Cx_dif $Cy_dif $Dx_dif $Dy_dif $Px_dif $Py_dif
DVAR $nozzle $nozzleA $nozzleB $nozzleC $nozzleD $profilometerRod $xStart $yStart $zStart 
DVAR $zMeasureA $zMeasureB $zMeasureC $zMeasureD $Az_dif $Bz_dif $Cz_dif $Dz_dif $xOffset $yOffset
DVAR $zA $zB $zC $zD $check
DVAR $zSweepRange $zSweepStep $numsteps $tempdistance $zDwell $count $z_dif $z_past $z_num $indicator $step $start $x_dist
DVAR $align_save
FILECLOSE 

$floor = -72
$deltafast = 1
$delta = 0.1
$fastfeed = 40
$midfeed = 10
$slowfeed = 2
$Astart = -15
$Bstart = -15
$Cstart = -15
$Dstart = -15
$Pstart = -15
$nozzleA=1
$nozzleB=2
$nozzleC=3
$nozzleD=4
$profilometerRod = 5

$Ax = 586.075
$Ay = 367.8285
$Bx = 482.075
$By = 367.8285
$Cx = 378.075
$Cy = 367.8285
$Dx = 299.075
$Dy = 367.8285
$Px = 148
$Py = 345

$DO0.0=0
$DO1.0=0
$DO2.0=0
$DO3.0=0
Primary ; sets primary units mm and s
G65 F2000; accel speed mm/s^2
G66 F2000;accel speed mm/s^2
ENABLE X Y A B C D U
POSOFFSET CLEAR X Y U A B C D
G91 ;start off in relative mode

G91
G92 X0.000000 Y0.000000 z0.000000
F100
G1 X-3.000000
Call setPress P5 Q60
Call togglePress P5
G4 P1
G1 X3.000000
G1 Y5.900000
G1 X5.900000
G1 Y-5.900000
G1 X-5.900000
G1 X0.100000 Y0.100000
G90
G1 z0.000000
G91
G1 Y5.700000
G1 X5.700000
G1 Y-5.700000
G1 X-5.700000
G90
G1 z0.100000
G91
G1 Y5.700000
G1 X5.700000
G1 Y-5.700000
G1 X-5.700000
G90
G1 z0.200000
G91
G1 Y5.700000
G1 X5.700000
G1 Y-5.700000
G1 X-5.700000
G90
G1 z0.300000
G91
G1 Y5.700000
G1 X5.700000
G1 Y-5.700000
G1 X-5.700000
G90
G1 z0.400000
G91
G1 Y5.700000
G1 X5.700000
G1 Y-5.700000
G1 X-5.700000
G90
G1 z0.500000
G91
G1 Y5.700000
G1 X5.700000
G1 Y-5.700000
G1 X-5.700000
G90
G1 z0.600000
G91
G1 Y5.700000
G1 X5.700000
G1 Y-5.700000
G1 X-5.700000
G90
G1 z0.700000
G91
G1 Y5.700000
G1 X5.700000
G1 Y-5.700000
G1 X-5.700000
G90
G1 z0.800000
G91
G1 Y5.700000
G1 X5.700000
G1 Y-5.700000
G1 X-5.700000
G90
G1 z0.900000
G91
Call togglePress P5
G4 P3
G1 X0.200000 Y0.200000
G90
G1 z0.000000
G91
Call togglePress P5
G1 Y5.300000
G1 X5.300000
G1 Y-5.300000
G1 X-5.300000
G90
G1 z0.100000
G91
G1 Y5.300000
G1 X5.300000
G1 Y-5.300000
G1 X-5.300000
G90
G1 z0.200000
G91
G1 Y5.300000
G1 X5.300000
G1 Y-5.300000
G1 X-5.300000
G90
G1 z0.300000
G91
G1 Y5.300000
G1 X5.300000
G1 Y-5.300000
G1 X-5.300000
G90
G1 z0.400000
G91
G1 Y5.300000
G1 X5.300000
G1 Y-5.300000
G1 X-5.300000
G90
G1 z0.500000
G91
G1 Y5.300000
G1 X5.300000
G1 Y-5.300000
G1 X-5.300000
G90
G1 z0.600000
G91
G1 Y5.300000
G1 X5.300000
G1 Y-5.300000
G1 X-5.300000
G90
G1 z0.700000
G91
G1 Y5.300000
G1 X5.300000
G1 Y-5.300000
G1 X-5.300000
G90
G1 z0.800000
G91
G1 Y5.300000
G1 X5.300000
G1 Y-5.300000
G1 X-5.300000
G90
G1 z0.900000
G91
Call togglePress P5
G1 X-0.100000 Y-0.100000
G90
G1 z0.800000
G91
Call togglePress P5
G1 Y5.500000
G1 X5.500000
G1 Y-5.500000
G1 X-5.500000
Call togglePress P5
G4 P5
G1 z3.000000
;#################################### Code ##########################################

M2

;##########Functions############;
DFS setPress        
         
        $strtask1 = DBLTOSTR( $P, 0 )            
        $strtask1 = "COM" + $strtask1
        $hFile = FILEOPEN $strtask1, 2
        COMMINIT $hFile, "baud=115200 parity=N data=8 stop=1"
        COMMSETTIMEOUT $hFile, -1, -1, 1000
                             
        $press = $Q * 10.0                             
        $strtask2 = DBLTOSTR( $press , 0 )  
      
      
        $length = STRLEN( $strtask2 )      
        WHILE $length < 4.0
                $strtask2 = "0" + $strtask2    
                $length = STRLEN( $strtask2 ) 
        ENDWHILE


        $strtask2 = "08PS  " + $strtask2
                                    
        $cCheck = 0.00     
        $lame = STRTOASCII ($strtask2, 0)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 1) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 2) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 3) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 4)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 5) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 6) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 7) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 8) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 9)  
        $cCheck = $cCheck - $lame
                        
        WHILE( $cCheck) < 0
                $cCheck = $cCheck + 256
        ENDWHILE                        


        $strtask3 = makestring "{#H}" $cCheck   
        $strtask3 = STRUPR( $strtask3 )
        $strtask2 = "\x02" + $strtask2 + $strtask3 + "\x03"
            
        FILEWRITE $hFile "\x05"
        FILEWRITE $hFile $strtask2
        FILEWRITE $hFile "\x04"


        FILECLOSE $hFile


ENDDFS


DFS togglePress        
         
        $strtask1 = DBLTOSTR( $P, 0 )            
        $strtask1 = "COM" + $strtask1
        $hFile = FILEOPEN $strtask1, 2
        COMMINIT $hFile, "baud=115200 parity=N data=8 stop=1"
        COMMSETTIMEOUT $hFile, -1, -1, 1000


        $strtask2 = "04DI  "
                                    
        $cCheck = 0.00     
        $lame = STRTOASCII ($strtask2, 0)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 1) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 2) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 3) 
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 4)
        $cCheck = $cCheck - $lame
        $lame = STRTOASCII( $strtask2, 5) 
        $cCheck = $cCheck - $lame
                        
        WHILE( $cCheck) < 0
                $cCheck = $cCheck + 256
        ENDWHILE                        


        $strtask3 = makestring "{#H}" $cCheck   
        $strtask3 = STRUPR( $strtask3 )
        $strtask2 = "\x02" + $strtask2 + $strtask3 + "\x03"
                  
        FILEWRITE $hFile "\x05"
        FILEWRITE $hFile $strtask2
        FILEWRITE $hFile "\x04"


        FILECLOSE $hFile
        G4 P0.15

ENDDFS

